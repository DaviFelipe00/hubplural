<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Análise de Custos</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .chart-container { position: relative; height: 100%; width: 100%; }
        /* Animação para o botão de refresh */
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .spinning { animation: spin 1s linear infinite; }
    </style>
</head>
<body class="bg-slate-900 text-slate-300">

<main class="p-6 lg:p-10 max-w-7xl mx-auto">
    <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-10">
        <div>
            <h1 class="text-3xl font-bold text-white">Análise de Custos e Economia</h1>
            <p id="header-date" class="text-slate-400 mt-1">Carregando data...</p>
        </div>
        <div class="flex items-center gap-4 mt-4 sm:mt-0">
            <button id="refresh-button" class="flex items-center gap-2 px-4 py-2 bg-slate-700/50 text-slate-300 rounded-lg hover:bg-slate-700 transition-colors focus:outline-none focus:ring-2 focus:ring-purple-500">
                <ion-icon name="refresh-outline" id="refresh-icon" class="text-xl"></ion-icon>
                <span>Atualizar</span>
            </button>
        </div>
    </header>

    <div class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-6 mb-10">
        <div class="bg-slate-800 p-6 rounded-xl shadow-lg ring-1 ring-white/10">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-red-600/20 text-red-400 rounded-lg flex items-center justify-center"><ion-icon name="cash-outline" class="text-2xl"></ion-icon></div>
                <div>
                    <h3 class="text-sm font-medium text-slate-400">Custo Original</h3>
                    <p id="kpi-original" class="text-2xl font-semibold text-white mt-1">R$ 0,00</p>
                </div>
            </div>
        </div>
        <div class="bg-slate-800 p-6 rounded-xl shadow-lg ring-1 ring-white/10">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-purple-600/20 text-purple-400 rounded-lg flex items-center justify-center"><ion-icon name="flag-outline" class="text-2xl"></ion-icon></div>
                <div>
                    <h3 class="text-sm font-medium text-slate-400">Custo Final</h3>
                    <p id="kpi-final" class="text-2xl font-semibold text-white mt-1">R$ 0,00</p>
                </div>
            </div>
        </div>
        <div class="bg-slate-800 p-6 rounded-xl shadow-lg ring-1 ring-white/10">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-green-600/20 text-green-400 rounded-lg flex items-center justify-center"><ion-icon name="wallet-outline" class="text-2xl"></ion-icon></div>
                <div>
                    <h3 class="text-sm font-medium text-slate-400">Economia Realizada</h3>
                    <p id="kpi-economia" class="text-2xl font-semibold text-white mt-1">R$ 0,00</p>
                </div>
            </div>
        </div>
        <div class="bg-slate-800 p-6 rounded-xl shadow-lg ring-1 ring-white/10">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-blue-600/20 text-blue-400 rounded-lg flex items-center justify-center"><ion-icon name="file-tray-stacked-outline" class="text-2xl"></ion-icon></div>
                <div>
                    <h3 class="text-sm font-medium text-slate-400">Total de Itens</h3>
                    <p id="kpi-servicos" class="text-2xl font-semibold text-white mt-1">0</p>
                </div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 xl:grid-cols-5 gap-6 mb-10">
        <div class="xl:col-span-3 bg-slate-800 p-6 rounded-xl shadow-lg ring-1 ring-white/10 h-96 flex flex-col">
            <h3 class="font-semibold text-white mb-4">Comparativo de Custos (Geral)</h3>
            <div class="chart-container">
                <canvas id="chartComparativoGeral"></canvas>
            </div>
        </div>
        <div class="xl:col-span-2 bg-slate-800 p-6 rounded-xl shadow-lg ring-1 ring-white/10 h-96 flex flex-col">
            <h3 class="font-semibold text-white mb-4">Economia por Fornecedor</h3>
            <div class="chart-container">
                <canvas id="chartEconomiaFornecedor"></canvas>
            </div>
        </div>
    </div>

    <div class="bg-slate-800 p-6 rounded-xl shadow-lg ring-1 ring-white/10">
        <h3 class="font-semibold text-white mb-4">Detalhamento dos Serviços</h3>
        <div class="overflow-x-auto">
            <table class="min-w-full">
                <thead class="border-b border-slate-700">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Fornecedor</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">Unidade</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-slate-400 uppercase tracking-wider">Custo Original</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-slate-400 uppercase tracking-wider">Custo Final</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-slate-400 uppercase tracking-wider">Economia</th>
                    </tr>
                </thead>
                <tbody id="tabela-servicos" class="divide-y divide-slate-700">
                    </tbody>
            </table>
        </div>
    </div>
</main>

<script>
    // URL da sua planilha publicada no formato CSV. ESSENCIAL que termine com '/pub?output=csv'
    const urlDaPlanilhaCSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTcbocWsEJJnb0Dwk_jI62Sz2mQFmvIi8qtx45n6xGLrvZ2uaCNDv60PSXQdxKlpUkjnuJ4CkOy0Gm1/pub?output=csv';

    const formatarMoeda = (valor) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(valor);
    
    function setDateHeader() {
        document.getElementById('header-date').textContent = new Date().toLocaleDateString('pt-BR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    }

    // Função para converter valores em texto (ex: "R$ 1.234,56") para número
    const parseCurrency = (valor) => {
        if (typeof valor !== 'string' || !valor) return 0;
        const cleanedValue = valor.replace(/R\$\s?/, '').replace(/\./g, '').replace(/,/g, '.');
        return parseFloat(cleanedValue) || 0;
    };

    async function buscarDadosDaPlanilha() {
        if (!urlDaPlanilhaCSV) { return []; }
        try {
            const resposta = await fetch(`${urlDaPlanilhaCSV}&t=${new Date().getTime()}`);
            if (!resposta.ok) { throw new Error(`Falha na rede: ${resposta.statusText}`); }
            
            const dadosCSV = await resposta.text();
             // Verifica se o link está retornando uma página HTML em vez de CSV puro
            if (dadosCSV.trim().startsWith('<')) {
                console.error("Erro: Os dados parecem ser HTML. Verifique se o link da planilha termina com '/pub?output=csv'");
                alert("Erro ao carregar dados. A planilha não está no formato CSV correto. Verifique o link em 'Arquivo > Compartilhar > Publicar na web' e certifique-se de selecionar 'Valores separados por vírgula (.csv)'.");
                return [];
            }

            const linhas = dadosCSV.trim().split('\n');
            
            // Usa regex para separar o cabeçalho, tratando colunas com vírgulas
            const cabecalho = (linhas[0].match(/(".*?"|[^,]*)(?=,|$)/g) || []).map(h => h.trim().replace(/^"|"$/g, ''));

            // Função flexível para encontrar o índice da coluna pelo nome
            const encontrarIndice = (nomesPossiveis) => {
                for (const nome of nomesPossiveis) {
                    const index = cabecalho.findIndex(h => h.toLowerCase().trim() === nome.toLowerCase());
                    if (index !== -1) return index;
                }
                return -1;
            };

            const indices = {
                fornecedor: encontrarIndice(['fornecedor']),
                unidade: encontrarIndice(['unidade']),
                descricao: encontrarIndice(['descrição do serviço', 'descricao']),
                custo: encontrarIndice(['custo', 'custo original']),
                final: encontrarIndice(['custo final', 'valor retornado', 'valor retor'])
            };
            
            return linhas.slice(1).map(linha => {
                // Usa regex para separar os valores de cada linha, tratando células com vírgulas
                const valores = linha.match(/(".*?"|[^,]*)(?=,|$)/g) || [];

                const getValor = (index) => {
                    if (index === -1 || !valores[index]) return '';
                    return valores[index].trim().replace(/^"|"$/g, '');
                };

                return {
                    Fornecedor: getValor(indices.fornecedor),
                    Unidade: getValor(indices.unidade),
                    Descricao: getValor(indices.descricao),
                    CustoOriginal: parseCurrency(getValor(indices.custo)),
                    CustoFinal: parseCurrency(getValor(indices.final))
                };
            }).filter(item => item.Fornecedor && (item.CustoOriginal > 0 || item.CustoFinal > 0 || item.Unidade)); // Garante que apenas linhas com dados sejam processadas

        } catch (error) {
            console.error("Erro detalhado ao buscar ou processar dados:", error);
            return []; 
        }
    }

    function calcularKPIs(dados) {
        const custoOriginal = dados.reduce((acc, item) => acc + item.CustoOriginal, 0);
        const custoFinal = dados.reduce((acc, item) => acc + item.CustoFinal, 0);
        const economia = custoOriginal - custoFinal;
        document.getElementById('kpi-original').textContent = formatarMoeda(custoOriginal);
        document.getElementById('kpi-final').textContent = formatarMoeda(custoFinal);
        document.getElementById('kpi-economia').textContent = formatarMoeda(economia);
        document.getElementById('kpi-servicos').textContent = dados.length;
    }

    function renderizarGraficos(dados) {
        const custoOriginal = dados.reduce((acc, item) => acc + item.CustoOriginal, 0);
        const custoFinal = dados.reduce((acc, item) => acc + item.CustoFinal, 0);
        
        const economiaPorFornecedor = dados.reduce((acc, item) => {
            if (item.Fornecedor) {
                const economiaItem = item.CustoOriginal - item.CustoFinal;
                acc[item.Fornecedor] = (acc[item.Fornecedor] || 0) + economiaItem;
            }
            return acc;
        }, {});
        
        const corTexto = '#9CA3AF', corGrid = '#475569';
        const coresPizza = ['#22c55e', '#8B5CF6', '#3B82F6', '#EC4899', '#f97316', '#14b8a6', '#6366f1'];
        
        if (window.graficoComparativoGeral) window.graficoComparativoGeral.destroy();
        window.graficoComparativoGeral = new Chart(document.getElementById('chartComparativoGeral'), {
            type: 'bar',
            data: {
                labels: ['Custos Totais'],
                datasets: [
                    { label: 'Custo Original', data: [custoOriginal], backgroundColor: '#ef4444', barPercentage: 0.5 },
                    { label: 'Custo Final', data: [custoFinal], backgroundColor: '#8B5CF6', barPercentage: 0.5 }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { labels: { color: corTexto } } }, scales: { x: { ticks: { color: corTexto, callback: (v) => formatarMoeda(v) }, grid: { color: corGrid } }, y: { ticks: { color: corTexto }, grid: { display: false } } } }
        });

        if (window.graficoEconomiaFornecedor) window.graficoEconomiaFornecedor.destroy();
        window.graficoEconomiaFornecedor = new Chart(document.getElementById('chartEconomiaFornecedor'), {
            type: 'doughnut', 
            data: { 
                labels: Object.keys(economiaPorFornecedor), 
                datasets: [{ data: Object.values(economiaPorFornecedor), backgroundColor: coresPizza, borderColor: '#1e293b' }] 
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: corTexto } } } }
        });
    }

    function preencherTabela(dados) {
        const tabelaCorpo = document.getElementById('tabela-servicos');
        tabelaCorpo.innerHTML = ''; // Limpa a tabela antes de preencher
        dados.forEach(item => {
            const economia = item.CustoOriginal - item.CustoFinal;
            const corEconomia = economia > 0 ? 'text-green-400' : (economia < 0 ? 'text-red-400' : 'text-slate-400');
            tabelaCorpo.innerHTML += `
                <tr class="hover:bg-slate-700/50 transition-colors">
                    <td class="px-4 py-4 text-sm font-medium text-white">${item.Fornecedor || '-'}</td>
                    <td class="px-4 py-4 text-sm text-slate-300">${item.Unidade || '-'}</td>
                    <td class="px-4 py-4 text-sm text-right font-medium text-slate-400">${formatarMoeda(item.CustoOriginal)}</td>
                    <td class="px-4 py-4 text-sm text-right font-medium text-purple-400">${formatarMoeda(item.CustoFinal)}</td>
                    <td class="px-4 py-4 text-sm text-right font-bold ${corEconomia}">${formatarMoeda(economia)}</td>
                </tr>`;
        });
    }

    async function inicializarDashboard() {
        const refreshIcon = document.getElementById('refresh-icon');
        refreshIcon.classList.add('spinning'); // Inicia a animação

        const dadosVivos = await buscarDadosDaPlanilha();
        if (dadosVivos && dadosVivos.length > 0) {
            calcularKPIs(dadosVivos);
            renderizarGraficos(dadosVivos);
            preencherTabela(dadosVivos);
        } else {
            console.log("Nenhum dado válido foi encontrado na planilha.");
        }
        
        refreshIcon.classList.remove('spinning'); // Para a animação
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        setDateHeader();
        inicializarDashboard();
        document.getElementById('refresh-button').addEventListener('click', inicializarDashboard);
    });

    // Descomente a linha abaixo se quiser que o dashboard atualize automaticamente
    // setInterval(inicializarDashboard, 300000); // Atualiza a cada 5 minutos
</script>

</body>
</html>